---
title: ""
author: ""
date: ""
output:
  html_document:
    number_sections: no
    toc: no
---

```{r setup, include=FALSE, echo=FALSE}

# START HERE: Enter a valid SurveyName below
SurveyName = '2024 DENA Moose Survey'

# You can get a list of SurveyNames by uncommenting the three lines below:
#SurveyNamesQuery = "SELECT DISTINCT SurveyName FROM GSPE_Surveys ORDER BY SurveyName" # Query to get a list of survey names
# SurveyNamesDataFrame = dbGetQuery(Connection,"SELECT DISTINCT SurveyName FROM GSPE_Surveys ORDER BY SurveyName") # Builds a data frame from the query above

# DOCUMENTATION
# This R Markdown file generates a skeleton summary report for an NPS Alaska Region Moose Survey. 
# The user can flesh out the report as needed.
# Author: NPS\SDMiller 
# Date: 2024-12-11
# Ensure your moose survey data is in the regional Moose SQL Server database and you
# have at minimum datareader permissions on the database.
 
# Load libraries
library(knitr)
library(ggplot2)
library(sp)
library(sf)
library(odbc)
library(leaflet)
library(sqldf)
library(ggnewscale)

# Build a database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna", Database = "Moose")

# Make kable show blanks for NAs
options(knitr.kable.NA = '')

# Current date
CurrentDate = Sys.Date() # Get the current date

# Function to convert a date string to a long date
GetLongDate <- function(Date) {
  return(format(as.Date(Date), format="%B %d, %Y "))
}

# These counters are used to number the tables and figures. Each gets incremented after use.
TableCounter = 1
FigureCounter = 1

```

```{r, label="Get survey details" , echo=FALSE}

# This query gets the survey details from the GSPE_Surveys database table
Sql = paste("SELECT 
-- SurveyName
[Year]
, Network
, Park
, Season
, StartDate
, EndDate
--, StartMonth
--, EndMonth
, AreaSurveyed_mi
, AverageSearchEffort
, Methodology
--, ProtocolVersion
--, ProtocolReferenceCode
--, Personnel
, ReportReferenceCode
--, ReportLink
--, DeliverablesDatasetReferenceCode
--, DataSource
--, DataResourcesDirectory
--, Summary
--, DatasetProcessingSteps
--, Comments
--, Abstract
FROM GSPE_Surveys 
WHERE SurveyName = '", SurveyName , "'",sep="")
GSPE_SurveysDF = dbGetQuery(Connection,Sql)

# Get the survey comments into a separate variable
Comments = GSPE_SurveysDF$Comments

# Get the project leader from the database, if known
Sql = paste("SELECT Investigator,Park FROM GSPE_Surveys WHERE SurveyName = '", SurveyName , "'",sep="")
InvestigatorDF = dbGetQuery(Connection,Sql)
Investigator = ''
Park = ''
if(nrow(InvestigatorDF)>0){
  Investigator = InvestigatorDF[1,1]
  Park = InvestigatorDF[1,2]
}

```


```{r,label="Get GSPE data", echo=FALSE}
# Extract a summary of data from the database
Sql = paste("SELECT 
 Park
, Year
, StartDate
, EndDate
, N
, [Records missing polygons]
, [Proportion of records certified]
 ,[Area of survey (Km^2)]
 ,[Area of surveyed units (Km^2)]
 ,[Area of survey (Mi^2)]
 ,[Area of surveyed units (Mi^2)]
, [Calves: 100 cows] as [Calves:100 cows (unadjusted)]
, [Bulls: 100 cows] as [Bulls:100 cows (unadjusted)]
, [Calves: 100 adults] as [Calves:100 adults (unadjusted)]
, [Minimum density (unadjusted moose/sq. mi.)]
, [Area_SqMi, counted]
, [N, counted]
, [N, not counted]
, [N, Counted is NULL]
, [Proportion of units counted]
, CALF
, [Total calves (Calculated)]
, COW_W_0
, COW_W_1
, COW_W_2
, COW_W_3
, COW
, [Total cows (Calculated)]
, YBULL_SF
, YBULL_GTSF
, SM_BULL
, MED_BULL
, MED_L_BULL
, LG_BULL
, BULL_30_40
, BULL_30_50
, BULL_30_60
, BULL_41_50
, BULL_GT_50
, BULL_GT_60
, BULL_GTE_50
, BULL_LT_30
, BULL_LT_50
, YBULL_ALL
, BULL_ALL
, [Total bulls (Calculated)]
, UNKNOWN
, ADULT
, [Total adults (Calculated)]
, MOOSE
, [Total moose (Calculated)]
, Personnel
, Report
, DeliverableDataset
, Protocol
, SurveyUnitSet
FROM Summary_GSPE
WHERE SurveyName = '", SurveyName , "'",sep="")
Summary_GSPEDF =  dbGetQuery(Connection,Sql) 

StartDate = Summary_GSPEDF$StartDate
StartDate = format(as.Date(Summary_GSPEDF$StartDate), "%B %d, %Y")
EndDate = format(as.Date(Summary_GSPEDF$EndDate), "%B %d, %Y")
Area_SqMi = Summary_GSPEDF$`Area of survey (Mi^2)`
Area_SqKm = Summary_GSPEDF$`Area of survey (Km^2)`
SurveyedUnitsArea_SqMi = Summary_GSPEDF$`Area of surveyed units (Mi^2)`
SurveyedUnitsArea_SqKm = Summary_GSPEDF$`Area of surveyed units (Km^2)`
```

# Survey Summary: `r SurveyName` (DRAFT)

<!-- `r Investigator`    -->
<!-- Wildlife Biologist, `r Park` -->
<!-- National Park Service    -->
<!-- [Address] -->


Scott D. Miller  
Information Technology Specialist
National Park Service, Arctic Inventory and Monitoring Network  
240 W. 5th Ave  
Anchorage, AK 99501  




`r format(Sys.Date(), "%B %d, %Y")`



```{r,label="GetAbstract", echo=FALSE}

# This query gets the survey details from the GSPE_Surveys database table
Sql = paste("SELECT Abstract FROM GSPE_Surveys WHERE SurveyName = '", SurveyName , "'",sep="")
AbstractDF = dbGetQuery(Connection,Sql)

```

[This report was generated by an automated [R Markdown script](https://github.com/NPS-ARCN-CAKN/Moose-Survey-Report) and presents a 'snapshot in time' summary of what is in the I&M moose monitoring database (SQL Server, inpyugamsvm01\nuna:Moose) for the titled moose survey. Results may change if new information is found. Open this html file in Microsoft Word and modify as needed for publication. Contact the Arctic or Central Alaska Inventory and Monitoring data manager for information.]

# Summary  
`r AbstractDF$Abstract` 

# Survey details

Details about the `r SurveyName` are presented in Table 1, below. 

Table 1. Survey details,  `r SurveyName`.

```{r,label="Get Dashboard data",echo=FALSE}
#kable(DetailsDF_t, caption = "Survey details")
kable(t(GSPE_SurveysDF),caption = "Survey summary", format = "html", escape = TRUE)

Sql = paste("SELECT 
-- Year, Park, Network, SurveyName
SurveyUnitSet
, Methodology
, RecordCount
, UnitsInSurveyUnitSet
, PolygonsCount
, PercentCertified
, ReportReferenceCode
, DeliverablesDatasetReferenceCode
, Season
, ProtocolVersion
, PopulationEstimateRecords
, DensityEstimateRecords
, DataSource
, DataResourcesDirectory
, ReportLink
 --, Comments
FROM Dashboard WHERE SurveyName = '",SurveyName,"'",sep='')

DashboardDF = dbGetQuery(Connection,Sql) 
DashboardDF_t = t(DashboardDF)
#colnames(DashboardDF_t) = ""
kable(DashboardDF_t, escape = TRUE)

```

# Survey Area

The survey area for the `r SurveyName` is shown in the map below (Figure 1).

```{r,label="Get spatial data and generate a map", echo = FALSE}

# Query the survey units. The polygons are in the Feature attribute
Sql = paste("SELECT ID,Counted,CASE WHEN SubArea IS NULL Then IsNULL(Park,'Park') ELSE SubArea End As SubArea
,Feature.EnvelopeCenter().Lat As Lat
, Feature.EnvelopeCenter().Long as Lon
, Feature.STArea() / 1000000 as Area_SqKm
, Feature.STArea() / 2589988.110336 as Area_SqMi
, SurveyUnitSet
, Feature.STAsBinary() AS Geog 
FROM Dataset_GSPE 
WHERE 
SurveyName = '",SurveyName,"'",sep='')

# Build a database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna", Database = "Moose")

# Get the data using the odbc method
Units = dbGetQuery(Connection,Sql)

# Now get the units having data (Moose > 0)
Sql = paste("SELECT ID,Counted,Moose
,Feature.EnvelopeCenter().Lat As Lat
, Feature.EnvelopeCenter().Long as Lon
, Feature.STArea() / 1000000 as Area_SqKm
, Feature.STArea() / 2589988.110336 as Area_SqMi
, SurveyUnitSet
, Feature.STAsBinary() AS Geog 
FROM Dataset_GSPE 
WHERE SurveyName = '",SurveyName,"' And Moose > 0",sep='')
UnitsWithMooseDF = dbGetQuery(Connection,Sql)

# If there are survey units associated with the study, then show them
if (nrow(Units) == 0){
  print("There are no survey units associated with this survey")
} else {
  bboxdf = sqldf("SELECT Min(Lat) as MinLat,Max(Lat) as MaxLat,Min(Lon) as MinLon,Max(Lon) as MaxLon FROM Units")
  
  # Convert the data frame into a spatial data frame using sf package
  UnitsSpatialDF <- sf::st_as_sf(subset(Units,!is.na(Units[,'Geog'])))
  UnitsWithMooseSpatialDF  <- sf::st_as_sf(subset(UnitsWithMooseDF,!is.na(UnitsWithMooseDF[,'Geog'])))
  
  # Set the coordinate system to GCS Lat\Lon WGS1984
  st_crs(UnitsSpatialDF) <- st_crs(4326)
  st_crs(UnitsWithMooseSpatialDF) <- st_crs(4326)
  
  # Load in the park boundaries geojson file from Data Store
  # Reference URL: https://irma.nps.gov/DataStore/Reference/Profile/2303652
  AK_ParksGeoJSON = "https://irma.nps.gov/DataStore/DownloadFile/704836"
  AK_Parks <- read_sf(AK_ParksGeoJSON,crs=4326)
  
  # Expansion factor to add to bounding box values so there is a little space between the units and the polygons
  expansionFactor = 1.002
  
  # Make a title for the map 
  PlotTitle = paste("Total moose observed by unit, ",SurveyName,sep="")
  
  # Plot the GSPE data
  ggplot() +
    # Park boundary
    geom_sf(data=AK_Parks,fill='gray90',color="black",alpha=1) + # Park boundaries
    
    # Units
    geom_sf(data = UnitsSpatialDF,aes(fill=SubArea),alpha=0.3,color='gray70') + #
    #scale_fill_viridis_d(name = "Sub-area") +
    scale_fill_brewer(palette = "RdBu",name="Sub-area") +
    
    # Moose
    new_scale_fill() + ## geoms added after this will use a new scale definition
    geom_sf(data = UnitsWithMooseSpatialDF,aes(fill=Moose)) +
    scale_fill_gradient(low = "gray", high = "black") + 
    # Label the units with the number of moose observed
    geom_text(data = UnitsWithMooseSpatialDF, mapping = aes(x = Lon, y = Lat, label = Moose), size = 3, color = "black") + 
    
    # Limit the map to the area around the survey units
    coord_sf(xlim = c(bboxdf$MinLon, bboxdf$MaxLon),ylim = c(bboxdf$MinLat,bboxdf$MaxLat),expand=TRUE) + # Limit to bounding box of surveyed
    
    ggtitle(PlotTitle) +
    
    theme_minimal() + # Minimal theme
    theme(
      panel.background = element_rect(fill = "white", color = NA),  # Background color of the panel
      plot.background = element_rect(fill = "white", color = NA),       # Background color of the plot
      panel.grid.major = element_line(color = "black"),                # Major grid lines
      panel.grid.minor = element_line(color = "black")                 # Minor grid lines
    )  

}
```


```{r,label="Map using Leaflet",echo=FALSE}
  # Map the units in Leaflet
  # leaflet() %>%
  #   
  #   # Set the view parameters and zoom level
  #   setView(lng = mean(UnitsSpatialDF$Lon), lat = mean(UnitsSpatialDF$Lat), zoom = 10) %>%
  #   
  #   # Add map tiles for the background from web map service
  #   addWMSTiles(
  #     'https://basemap.nationalmap.gov:443/arcgis/services/USGSTopo/MapServer/WmsServer',
  #     layers = "0",
  #     options = WMSTileOptions(format = "image/png")
  #   )  %>%
  #   
  #   # Add the moose units (polygons are in the Geog attributes)
  #   addPolygons(data=UnitsSpatialDF$Geog,color = "black", weight = 1, smoothFactor = 0.5, fillOpacity = 0.1) %>%
  #   
  #   # Add labels
  #   addLabelOnlyMarkers(~Lon,~Lat, label = ~ID, data = UnitsSpatialDF, labelOptions = labelOptions(noHide = TRUE))

```


Figure 1. Map of survey units, `r SurveyName`. Park boundary is shown in gray. 

```{r,label="Get survey units area data", echo=FALSE}

# Get a data frame of units and their area to present to the report
# UnitsDF = Units[,c("ID","Lat","Lon","Area_SqKm","Area_SqMi")] 
# colnames(UnitsDF) = c("ID","Latitude","Longitude","Area (Sq. km)","Area (Sq. mi.)")
# 
# TotalAreaKm = sum(Units$`Area (Sq. km)`,na.rm=TRUE)
# TotalAreaMi = sum(Units$`Area (Sq. mi.)`,na.rm=TRUE)
# n = colSums(!is.na(UnitsDF))[4] # Count of the number of units with area

```

# Results

Survey results are presented in Table3, below. Please note these results are calculated automatically by the database and may not account for the unique factors that affect a moose survey (logistical or weather problems, whether a sightability correction factor was generated and applied, missing or incomplete data collection, missing units, partially surveyed units, differing methods among flight crews, etc.). Consult the [survey report](`r DashboardDF$ReportLink`) to interpret results.

Table 3. Survey results.

```{r,label="Table of survey summary data", echo=FALSE}
knitr::kable(t(Summary_GSPEDF))
```

# Discussion

[To be written]

```{r,label="Get summary and data processing data", echo=FALSE}

# This query gets the survey details from the GSPE_Surveys database table
Sql = paste("SELECT 
  Summary
, DatasetProcessingSteps
, Comments
, Abstract
FROM GSPE_Surveys 
WHERE SurveyName = '", SurveyName , "'",sep="")
MoreDetailsDF = dbGetQuery(Connection,Sql)

Summary = MoreDetailsDF$Summary
DatasetProcessingSteps = MoreDetailsDF$DatasetProcessingSteps
Comments = MoreDetailsDF$Comments
```

```{r,label="Write the report to the survey directory", echo=FALSE}

# This template will output to an html file named MooseSurveyReport.htms
# Rename it and copy it to the survey directory if it exists
# Otherwise rename it in the current directory
From = "MooseSurveyReport.html"

# Set up the source file title
ReportTitle = paste(SurveyName," Summary.html",sep="")


# Check if the survey directory exists
# Set up a destination file path for the file copy operation
if (dir.exists(DashboardDF$DataResourcesDirectory)) {
  To=paste(DashboardDF$DataResourcesDirectory,"/",ReportTitle,sep="")
} else {
  To=ReportTitle
}

# Try to copy the file to the destination
tryCatch({
  file.copy(From, To, overwrite = TRUE)
  message(paste("Survey report ",From," generated and and copied to ",To,sep=""))
}, error = function(e) {
  
  # An error happened
  message("Error: ", e$message)
  
})


```
