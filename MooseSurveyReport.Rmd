---
title: ""
author: ""
date: ""
output:
  html_document:
    number_sections: no
    toc: no
---

```{r setup, include=FALSE, echo=FALSE}

# Enter a valid SurveyName from the moose monitoring database
SurveyName = '2023 WRST Moose Survey'


# Load libraries
library(knitr)
library(ggplot2)
library(sp)
library(sf)
library(odbc)
library(leaflet)
library(sqldf)

# Database connection 
#Connection = odbcDriverConnect(connection = "Driver=SQL Server Native Client 11.0;Server=inpyugamsvm01\\nuna;Database=Moose;trusted_connection=YES")

# Build a database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna", Database = "Moose")

# DOCUMENTATION
# This R Markdown file generates a skeleton summary report for an NPS Alaska Region Moose Survey. 
# The user can flesh out the report as needed.
# Author: NPS\SDMiller 
# Date: 2023-12-21
# Ensure your moose survey data is in the regional Moose SQL Server database and you
# have at minimum datareader permissions on the database.
# Set up the report parameters below before running.

# Start by entering a valid SurveyName above from the Moose database (\\inpyugamsvm01\nuna:Moose) on which to build the report

# You can get a list of SurveyNames by uncommenting the three lines below:
# SurveyNamesQuery = "SELECT DISTINCT SurveyName FROM GSPE_Surveys ORDER BY SurveyName" # Query to get a list of survey names
# SurveyNamesDataFrame = dbGetQuery(Connection,"SELECT DISTINCT SurveyName FROM GSPE_Surveys ORDER BY SurveyName") # Builds a data frame from the query above

# Make kable show blanks for NAs
options(knitr.kable.NA = '')

# Current date
CurrentDate = Sys.Date() # Get the current date

# Function to convert a date string to a long date
GetLongDate <- function(Date) {
  return(format(as.Date(Date), format="%B %d, %Y "))
}

# These counters are used to number the tables and figures. Each gets incremented after use.
TableCounter = 1
FigureCounter = 1

```

```{r, label="Get surveys" , echo=FALSE}

# This query gets the survey details from the GSPE_Surveys database table
Sql = paste("SELECT 
-- SurveyName
[Year]
, Network
, Park
, Season
, StartDate
, EndDate
--, StartMonth
--, EndMonth
, AreaSurveyed_mi
, AverageSearchEffort
, Methodology
--, ProtocolVersion
--, ProtocolReferenceCode
--, Personnel
, ReportReferenceCode
--, ReportLink
--, DeliverablesDatasetReferenceCode
--, DataSource
--, DataResourcesDirectory
--, Summary
--, DatasetProcessingSteps
--, Comments
--, Abstract
FROM GSPE_Surveys 
WHERE SurveyName = '", SurveyName , "'",sep="")
GSPE_SurveysDF = dbGetQuery(Connection,Sql)

# Get the survey comments into a separate variable
Comments = GSPE_SurveysDF$Comments

```


```{r,label="Get GSPE data", echo=FALSE}
# Extract a summary of data from the database
Sql = paste("SELECT 
 Park
, Year
, StartDate
, EndDate
, N
, [Records missing polygons]
, [Proportion of records certified]
, [Area surveyed (sq. mi.)]
, [Area surveyed (sq. km.)]
, [Calves: 100 cows]
, [Bulls: 100 cows]
, [Calves: 100 adults]
, [Minimum density (unadjusted moose/sq. mi.)]
, [Area_SqMi, counted]
, [N, counted]
, [N, not counted]
, [N, Counted is NULL]
, [Proportion of units counted]
, CALF
, [Total calves (Calculated)]
, COW_W_0
, COW_W_1
, COW_W_2
, COW_W_3
, COW
, [Total cows (Calculated)]
, YBULL_SF
, YBULL_GTSF
, SM_BULL
, MED_BULL
, MED_L_BULL
, LG_BULL
, BULL_30_40
, BULL_30_50
, BULL_30_60
, BULL_41_50
, BULL_GT_50
, BULL_GT_60
, BULL_GTE_50
, BULL_LT_30
, BULL_LT_50
, YBULL_ALL
, BULL_ALL
, [Total bulls (Calculated)]
, UNKNOWN
, ADULT
, [Total adults (Calculated)]
, MOOSE
, [Total moose (Calculated)]
, Personnel
, Report
, DeliverableDataset
, Protocol
, SurveyUnitSet
FROM Summary_GSPE
WHERE SurveyName = '", SurveyName , "'",sep="")
Summary_GSPEDF =  dbGetQuery(Connection,Sql) 

StartDate = Summary_GSPEDF$StartDate
StartDate = format(as.Date(Summary_GSPEDF$StartDate), "%B %d, %Y")
EndDate = format(as.Date(Summary_GSPEDF$EndDate), "%B %d, %Y")
Area_SqMi = Summary_GSPEDF$Area_SqMi
Area_SqKm = Summary_GSPEDF$Area_SqKM
```

# Survey Summary: `r SurveyName`


Scott D. Miller  
Information Technology Specialist
National Park Service, Arctic Inventory and Monitoring Network  
240 W. 5th Ave  
Anchorage, AK 99501  




`r format(Sys.Date(), "%B %d, %Y")`







```{r,label="GetAbstract", echo=FALSE}

# This query gets the survey details from the GSPE_Surveys database table
Sql = paste("SELECT Abstract FROM GSPE_Surveys WHERE SurveyName = '", SurveyName , "'",sep="")
AbstractDF = dbGetQuery(Connection,Sql)

```

[This report was generated by an automated [R Markdown script](https://github.com/NPS-ARCN-CAKN/Moose-Survey-Report) and presents a 'snapshot in time' summary of what is in the I&M moose monitoring database (SQL Server, inpyugamsvm01\nuna:Moose) for the titled moose survey at the time of publication. Results may change if new information is found. Open this html file in Microsoft Word and modify as needed for publication. Contact the Arctic or Central Alaska Inventory and Monitoring data manager for information.]

# Abstract  
`r AbstractDF$Abstract` 

# Survey details

Details about the `r SurveyName` are presented in Table 1, below. 

Table 1. Survey details,  `r SurveyName`.

```{r,label="Get Dashboard data",echo=FALSE}
#kable(DetailsDF_t, caption = "Survey details")
kable(t(GSPE_SurveysDF),caption = "Survey summary")

Sql = paste("SELECT 
-- Year, Park, Network, SurveyName
SurveyUnitSet
, Methodology
, RecordCount
, UnitsInSurveyUnitSet
, PolygonsCount
, PercentCertified
, ReportReferenceCode
, DeliverablesDatasetReferenceCode
, Season
, ProtocolVersion
, PopulationEstimateRecords
, DensityEstimateRecords
, DataSource
, DataResourcesDirectory
, ReportLink
 --, Comments
FROM Dashboard WHERE SurveyName = '",SurveyName,"'",sep='')

DashboardDF = dbGetQuery(Connection,Sql) 
DashboardDF_t = t(DashboardDF)
#colnames(DashboardDF_t) = ""
kable(DashboardDF_t)

```



# Survey Area

The survey area for the `r SurveyName` is shown in the map below (Figure 1).
<!--  Table 2 provides information about the survey units including boundaries, center points and area. -->

```{r,label="Get spatial data and generate a map", echo = FALSE}

# Query the survey units. The polygons are in the Feature attribute
Sql = paste("SELECT ID,Counted
,Feature.EnvelopeCenter().Lat As Lat
, Feature.EnvelopeCenter().Long as Lon
, Feature.STArea() / 1000000 as Area_SqKm
, Feature.STArea() / 2589988.110336 as Area_SqMi
, SurveyUnitSet
, Feature.STAsBinary() AS Geog 
FROM Dataset_GSPE 
WHERE 
SurveyName = '",SurveyName,"'",sep='')

# Build a database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna", Database = "Moose")

# Get the data using the odbc method
DF = dbGetQuery(Connection,Sql)

# If there are survey units associated with the study, then show them
if (nrow(DF) == 0){
  print("There are no survey units associated with this survey")
} else {
  bboxdf = sqldf("SELECT Min(Lat) as MinLat,Max(Lat) as MaxLat,Min(Lon) as MinLon,Max(Lon) as MaxLon FROM DF")
  
  # Convert the data frame into a spatial data frame using sf package
  # Exclude NA geographies
  SpatialDF <- sf::st_as_sf(subset(DF,!is.na(DF[,'Geog'])))
   
  # Set the coordinate system to GCS Lat\Lon WGS1984
  st_crs(SpatialDF) <- st_crs(4326)
  
  # Load in the park boundaries geojson file from Data Store
  # Reference URL: https://irma.nps.gov/DataStore/Reference/Profile/2303652
  AK_ParksGeoJSON = "https://irma.nps.gov/DataStore/DownloadFile/704836"
  AK_Parks <- read_sf(AK_ParksGeoJSON,crs=4326)
  
  # Expansion factor to add to bounding box values so there is a little space between the units and the polygons
  expansionFactor = 1.002
  
  # Plot the units in ggplot
  # If this is a GSPE survey there will be too many units for labels to show neatly
  # The first option omits labels, the second includes them
  if (is.na(DF[1,"SurveyUnitSet"])== FALSE & DF[1,"SurveyUnitSet"] == "ADFG GSPE"){
    ggplot() +
    geom_sf(data=AK_Parks,fill="lightgray",color="darkgray") + # Park boundaries
    geom_sf(data = SpatialDF) + # Survey units
    #geom_text(data = SpatialDF, mapping = aes(x = Lon, y = Lat, label = ID), size = 3, color = "black") + # Unit labels
    coord_sf(xlim = c(bboxdf$MinLon, bboxdf$MaxLon),ylim = c(bboxdf$MinLat,bboxdf$MaxLat),expand=TRUE) + # Limit to bounding box of surveyed units
    theme_minimal() # Minimal theme
  } else {
  
      ggplot() +
      geom_sf(data=AK_Parks,fill="lightgray",color="darkgray") + # Park boundaries
      geom_sf(data = SpatialDF,aes(fill=Counted)) + # Survey units
      geom_text(data = SpatialDF, mapping = aes(x = Lon, y = Lat, label = ID), size = 3, color = "black") + # Unit labels
      coord_sf(xlim = c(bboxdf$MinLon * expansionFactor, bboxdf$MaxLon * 1/expansionFactor),ylim = c(bboxdf$MinLat * 1/expansionFactor,bboxdf$MaxLat * expansionFactor),expand=TRUE) + # Limit to bounding box of surveyed units
      theme_minimal() # Minimal theme
    
  }

  # Map the units in Leaflet
  # leaflet() %>%
  #   
  #   # Set the view parameters and zoom level
  #   setView(lng = mean(SpatialDF$Lon), lat = mean(SpatialDF$Lat), zoom = 10) %>%
  #   
  #   # Add map tiles for the background from web map service
  #   addWMSTiles(
  #     'https://basemap.nationalmap.gov:443/arcgis/services/USGSTopo/MapServer/WmsServer',
  #     layers = "0",
  #     options = WMSTileOptions(format = "image/png")
  #   )  %>%
  #   
  #   # Add the moose units (polygons are in the Geog attributes)
  #   addPolygons(data=SpatialDF$Geog,color = "black", weight = 1, smoothFactor = 0.5, fillOpacity = 0.1) %>%
  #   
  #   # Add labels
  #   addLabelOnlyMarkers(~Lon,~Lat, label = ~ID, data = SpatialDF, labelOptions = labelOptions(noHide = TRUE))

}

```

Figure 1. Map of survey units, `r SurveyName`. Park boundary is shown in gray. 

```{r,label="Get survey units area data", echo=FALSE}

# Get a data frame of units and their area to present to the report
UnitsDF = DF[,c("ID","Lat","Lon","Area_SqKm","Area_SqMi")] 
colnames(UnitsDF) = c("ID","Latitude","Longitude","Area (Sq. km)","Area (Sq. mi.)")

TotalAreaKm = sum(UnitsDF$`Area (Sq. km)`,na.rm=TRUE)
TotalAreaMi = sum(UnitsDF$`Area (Sq. mi.)`,na.rm=TRUE)
n = colSums(!is.na(UnitsDF))[4] # Count of the number of units with area

```

# Results

Survey results are presented in Table3, below. Please note these results are calculated automatically by the database and may not account for the unique factors that affect a moose survey (logistical or weather problems, whether a sightability correction factor was generated and applied, missing or incomplete data collection, missing units, partially surveyed units, differing methods among flight crews, etc.). Consult the [survey report](`r DashboardDF$ReportLink`) to interpret results.

Table 3. Survey results.

```{r,label="Get survey summary data", echo=FALSE}
Sql = paste("SELECT Park
, Year
--, StartDate
-- , EndDate
, N
, [Records missing polygons]
, [Proportion of records certified]
, [Area surveyed (sq. mi.)]
, [Area surveyed (sq. km.)]
, [Calves: 100 cows]
, [Bulls: 100 cows]
, [Calves: 100 adults]
, [Minimum density (unadjusted moose/sq. mi.)]
, [N, counted]
, [N, not counted]
, [N, Counted is NULL]
, [Proportion of units counted]
, CALF
, [Total calves (Calculated)]
, COW_W_0
, COW_W_1
, COW_W_2
, COW_W_3
, COW
--, [Total cows (Calculated)]
, YBULL_SF
, YBULL_GTSF
, SM_BULL
, MED_BULL
, MED_L_BULL
, LG_BULL
, BULL_30_40
, BULL_30_50
, BULL_30_60
, BULL_41_50
, BULL_GT_50
, BULL_GT_60
, BULL_GTE_50
, BULL_LT_30
, BULL_LT_50
, YBULL_ALL
, BULL_ALL
--, [Total bulls (Calculated)]
, UNKNOWN
, ADULT
--, [Total adults (Calculated)]
, MOOSE
--, [Total moose (Calculated)]
--, Personnel
--, Report
--, DeliverableDataset
--, Protocol
--, SurveyUnitSet 
FROM Summary_GSPE
WHERE SurveyName = '",SurveyName,"'",sep='')

Summary_ResultsDF = dbGetQuery(Connection,Sql) 
Summary_ResultsDF_t = t(Summary_ResultsDF)
colnames(Summary_ResultsDF_t) = NULL
kable(Summary_ResultsDF_t)

```

# Discussion

[To be written]

```{r,label="Get summary and data processing data", echo=FALSE}

# This query gets the survey details from the GSPE_Surveys database table
Sql = paste("SELECT 
  Summary
, DatasetProcessingSteps
, Comments
, Abstract
FROM GSPE_Surveys 
WHERE SurveyName = '", SurveyName , "'",sep="")
MoreDetailsDF = dbGetQuery(Connection,Sql)

Summary = MoreDetailsDF$Summary
DatasetProcessingSteps = MoreDetailsDF$DatasetProcessingSteps
Comments = MoreDetailsDF$Comments
```

# Appendices (Not for publication)

## Appendix A: Comments 

Appendix A contains information about the survey that may be important to consumers of the data.

`r Comments`

## Appendix B: Dataset Processing Steps  

Appendix B contains a list of quality control procedures and processing steps that were taken to add value to the dataset.

`r DatasetProcessingSteps`


```{r,label="Write the report to the survey directory", echo=FALSE}

# This template will output to an html file named MooseSurveyReport.htms
# Rename it and copy it to the survey directory if it exists
# Otherwise rename it in the current directory
From = "MooseSurveyReport.html"

# Set up the source file title
ReportTitle = paste(SurveyName," Summary.html",sep="")

# Check if the survey directory exists
# Set up a destination file path for the file copy operation
if (dir.exists(DashboardDF$DataResourcesDirectory)) {
  To=paste(DashboardDF$DataResourcesDirectory,"/",ReportTitle,sep="")
} else {
  To=ReportTitle
}

# Try to copy the file to the destination
tryCatch({
  file.copy(From, To, overwrite = TRUE)
}, error = function(e) {
  # An error happened
  message("Error: ", e$message)
})

#Where to get the report
print(paste("Survey report generated in ",From," and copied to ",To,sep=""))



```




