---
title: ""
author: ""
date: ""
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    collapsed: false
    smooth_scroll: false
---

```{r setup, include=FALSE, echo=FALSE}

# START HERE: Enter a valid SurveyName below
SurveyName = '2024 DENA Moose Survey'

# You can get a list of SurveyNames by uncommenting the three lines below:
#SurveyNamesQuery = "SELECT DISTINCT SurveyName FROM GSPE_Surveys ORDER BY SurveyName" # Query to get a list of survey names
# SurveyNamesDataFrame = dbGetQuery(Connection,"SELECT DISTINCT SurveyName FROM GSPE_Surveys ORDER BY SurveyName") # Builds a data frame from the query above

# DOCUMENTATION
# This R Markdown file generates a skeleton summary report for an NPS Alaska Region Moose Survey. 
# The user can flesh out the report as needed.
# Author: NPS\SDMiller 
# Date: 2024-12-11
# Ensure your moose survey data is in the regional Moose SQL Server database and you
# have at minimum datareader permissions on the database.
 
# Load libraries
library(knitr)
library(ggplot2)
library(sp)
library(sf)
library(odbc)
library(leaflet)
library(sqldf)
library(ggnewscale)

# Build a database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna", Database = "Moose")

# Make kable show blanks for NAs
options(knitr.kable.NA = '')

# Current date
CurrentDate = Sys.Date() # Get the current date

# Function to convert a date string to a long date
GetLongDate <- function(Date) {
  return(format(as.Date(Date), format="%B %d, %Y "))
}

# These counters are used to number the tables and figures. Each gets incremented after use.
TableCounter = 1
FigureCounter = 1
QCTestCounter = 1
```

```{r,label="Get Dashboard data",echo=FALSE}
Sql = paste("SELECT 
-- Year, Park, Network, SurveyName
SurveyUnitSet
, Methodology
, RecordCount
, UnitsInSurveyUnitSet
, PolygonsCount
, PercentCertified
, ReportReferenceCode
, DeliverablesDatasetReferenceCode
, Season
, ProtocolVersion
, PopulationEstimateRecords
, DensityEstimateRecords
, DataSource
, DataResourcesDirectory
, ReportLink
 --, Comments
FROM Dashboard WHERE SurveyName = '",SurveyName,"'",sep='')

DashboardDF = dbGetQuery(Connection,Sql) 
DashboardDF_t = t(DashboardDF)


```

# Quality Control Report: `r SurveyName`

Scott D. Miller\
Information Technology Specialist National Park Service, Arctic Inventory and Monitoring Network\
240 W. 5th Ave\
Anchorage, AK 99501

`r format(Sys.Date(), "%B %d, %Y")`

# Introduction

Moose surveys are conducted in Alaska by the National Park Service. Field data are collected during surveys and then ingested into a master database. This report shows the results of numerous automated quality control procedures in order to provide feedback on data deficiencies to be resolved or documented. The results presented here are not intended for publication, but to provide a snapshot-in-time assessment of the quality of the data collected during a survey.

This report was generated from an R Markdown file available at <https://github.com/NPS-ARCN-CAKN/Moose-R-Markdown>

# Abstract

```{r echo=FALSE, label = "Abstract"}

# Run the quality control query
Sql = paste("SELECT Abstract FROM GSPE_Surveys WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)
knitr::kable(DF)
TableCounter = TableCounter + 1 

```

# Dataset Dashboard

```{r,echo=FALSE, tab.cap=paste("Table ",TableCounter,". Dataset dashboard.",sep=""), label="Dashboard"}
kable(DashboardDF_t, escape = TRUE)
```

# Map

The survey area for the `r SurveyName` is shown in the map below (Figure 1).

```{r,label="Get spatial data and generate a map", echo = FALSE}

# Query the survey units. The polygons are in the Feature attribute
Sql = paste("SELECT ID,Counted,CASE WHEN SubArea IS NULL Then IsNULL(Park,'Park') ELSE SubArea End As SubArea
,Feature.EnvelopeCenter().Lat As Lat
, Feature.EnvelopeCenter().Long as Lon
, Feature.STArea() / 1000000 as Area_SqKm
, Feature.STArea() / 2589988.110336 as Area_SqMi
, SurveyUnitSet
, Feature.STAsBinary() AS Geog 
FROM Dataset_GSPE 
WHERE 
SurveyName = '",SurveyName,"'",sep='')

# Build a database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna", Database = "Moose")

# Get the data using the odbc method
Units = dbGetQuery(Connection,Sql)

# Now get the units having data (Moose > 0)
Sql = paste("SELECT ID,Counted,Moose
,Feature.EnvelopeCenter().Lat As Lat
, Feature.EnvelopeCenter().Long as Lon
, Feature.STArea() / 1000000 as Area_SqKm
, Feature.STArea() / 2589988.110336 as Area_SqMi
, SurveyUnitSet
, Feature.STAsBinary() AS Geog 
FROM Dataset_GSPE 
WHERE SurveyName = '",SurveyName,"' And Moose > 0",sep='')
UnitsWithMooseDF = dbGetQuery(Connection,Sql)

# If there are survey units associated with the study, then show them
if (nrow(Units) == 0){
  print("There are no survey units associated with this survey")
} else {
  bboxdf = sqldf("SELECT Min(Lat) as MinLat,Max(Lat) as MaxLat,Min(Lon) as MinLon,Max(Lon) as MaxLon FROM Units")
  
  # Convert the data frame into a spatial data frame using sf package
  UnitsSpatialDF <- sf::st_as_sf(subset(Units,!is.na(Units[,'Geog'])))
  UnitsWithMooseSpatialDF  <- sf::st_as_sf(subset(UnitsWithMooseDF,!is.na(UnitsWithMooseDF[,'Geog'])))
  
  # Set the coordinate system to GCS Lat\Lon WGS1984
  st_crs(UnitsSpatialDF) <- st_crs(4326)
  st_crs(UnitsWithMooseSpatialDF) <- st_crs(4326)
  
  # Load in the park boundaries geojson file from Data Store
  # Reference URL: https://irma.nps.gov/DataStore/Reference/Profile/2303652
  AK_ParksGeoJSON = "https://irma.nps.gov/DataStore/DownloadFile/704836"
  AK_Parks <- read_sf(AK_ParksGeoJSON,crs=4326)
  
  # Expansion factor to add to bounding box values so there is a little space between the units and the polygons
  expansionFactor = 1.002
  
  # Make a title for the map 
  PlotTitle = paste("Total moose observed by unit, ",SurveyName,sep="")
  
  # Plot the GSPE data
  ggplot() +
    # Park boundary
    geom_sf(data=AK_Parks,fill='gray90',color="black",alpha=1) + # Park boundaries
    
    # Units
    geom_sf(data = UnitsSpatialDF,aes(fill=SubArea),alpha=0.3,color='gray70') + #
    #scale_fill_viridis_d(name = "Sub-area") +
    scale_fill_brewer(palette = "RdBu",name="Sub-area") +
    
    # Moose
    new_scale_fill() + ## geoms added after this will use a new scale definition
    geom_sf(data = UnitsWithMooseSpatialDF,aes(fill=Moose)) +
    scale_fill_gradient(low = "gray", high = "black") + 
    # Label the units with the number of moose observed
    geom_text(data = UnitsWithMooseSpatialDF, mapping = aes(x = Lon, y = Lat, label = Moose), size = 3, color = "black") + 
    
    # Limit the map to the area around the survey units
    coord_sf(xlim = c(bboxdf$MinLon, bboxdf$MaxLon),ylim = c(bboxdf$MinLat,bboxdf$MaxLat),expand=TRUE) + # Limit to bounding box of surveyed
    
    ggtitle(PlotTitle) +
    
    theme_minimal() + # Minimal theme
    theme(
      panel.background = element_rect(fill = "white", color = NA),  # Background color of the panel
      plot.background = element_rect(fill = "white", color = NA),       # Background color of the plot
      panel.grid.major = element_line(color = "black"),                # Major grid lines
      panel.grid.minor = element_line(color = "black")                 # Minor grid lines
    )  

}
```

# Quality Control Test Results

Quality control is an important part of the long-term moose monitoring program in the National Parks of Alaska. The moose monitoring database has numerous automated quality control queries that can elucidate problem areas for correction. Some data defects cannot be rectified, and in such cases these defects have been documented. This section reports the results of quality control checks.

```{r,echo=FALSE, label="SQL query to generate the QC sections below"}

# select '## QC Test `r QCTestCounter`: ' + [Table] + '
# 
# ```{r echo=FALSE, label = "Quality control query test results: '+[Table]+'",results=''asis''}
# 
# # Run the quality control query
# Sql = paste("' + SelectQuery + ' WHERE SurveyName=''",SurveyName,"''",sep="")
# DF = dbGetQuery(Connection,Sql)
# 
# # Print a Pass/Fail message with failing records summary
# if(nrow(DF) > 0){
#   cat("\n**FAILED**\n\n")
#   # Output the results
#   Caption = paste("Table ",TableCounter,". Quality control query test results: '+[Table]+'",sep="")
#   print(knitr::kable(DF, caption = Caption))
# } else {
#   cat("\nPASSED\n")
# }
# # I don''t know why this bombs the if block above, but I had to put it here
# if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
# if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
# ```
# 
# SQL: `r Sql`
# 
# '
# from DatabaseTableDescriptions
# where type='v' and [table] like 'QC%'

# SQL: `r Sql`
# 
# '
# from DatabaseTableDescriptions
# where type='v' and [table] like 'QC%'
# 
# ```

```

## QC Test `r QCTestCounter`: QC_GSPE_RecordCountsByCertificationLevel

This quality control test shows the progress toward dataset certification. Certifification levels in progression are as follows:

| Certification level | Definition |
|------------------|------------------------------------------------------|
| Raw | Raw field data that have not undergone any quality control procedures. |
| Provisional | Data that have been validated against field data collection forms or spreadsheet and that give no evidence of being invalid, but for which no secondary sources exist in order to validate the data (i.e. no report - just a file). |
| Certified | Data that have been validated against source data collection files and/or forms and, additionally, secondary reports, summaries or verbal communications from project leaders confirming that the data are correct and true. |

: Certification levels and descriptions.

Raw data should never be used in analytical reports. Provisional data are permissible for internal analyses and summaries. Only certified data should be used for public facing reports.

```{r echo=FALSE, label = "Quality control query test results: QC_GSPE_RecordCountsByCertificationLevel"}

# Run the quality control query
Sql = paste("SELECT CertificationLevel,[Record count] FROM [QC_GSPE_RecordCountsByCertificationLevel] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)
Caption = paste("Table ",TableCounter,". Number of records by certification level summary.",sep="")
knitr::kable(DF, caption = Caption)
TableCounter = TableCounter + 1  
QCTestCounter = QCTestCounter + 1
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: Record Counts and Record Count

This is an informational test showing the number of records in the dataset and percent of the records that are certified.

```{r echo=FALSE, label = "Quality control query test results: QC_UncertifiedSurveys"}

# Run the quality control query
Sql = paste("SELECT [RecordCount]
      ,[PercentCertified]
      ,[ValidatedDate]
      ,[ValidatedBy]
      ,[ReportReferenceCode]
  FROM [Moose].[dbo].[QC_UncertifiedSurveys] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)
# Output the results
Caption = paste("Table ",TableCounter,". Quality control query test results: QC_UncertifiedSurveys",sep="")
knitr::kable(t(DF), caption = Caption)
TableCounter = TableCounter + 1
## QC Test `r QCTestCounter`:
```

SQL: `r Sql`

## QC Test: Missing records (Empty survey)

There are many historical moose surveys in the database for which no records have been recovered. This test will fail if there is a Survey record with no associated data.

```{r echo=FALSE, label = "Surveys missing records (Empty surveys) - Count.",results='asis'}
# Run the quality control query
Sql = paste("SELECT count(*) as [Surveys missing records] FROM Dashboard where RecordCount = 0 And  SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(DF$`Surveys missing records` != 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_CertificationStatus",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 

```

## QC Test `r QCTestCounter`: Missing units

Ideally the survey unit boundaries should be known for each moose unit surveyed. Occasionally, these units have been lost entirely, or certain individual units are missing for other reasons (a unit may have been added spontaneously, or a unit may have been subdivided without documentation). Table `r TableCounter` lists surveys records for which there are no unit polygons.

```{r echo=FALSE, label = "Surveys having missing survey unit polygons.",results='asis'}


Sql = paste("SELECT RecordCount, PolygonsCount,RecordCount-PolygonsCount as NullFeature, PercentCertified, Methodology
FROM     Dashboard 
WHERE recordcount>0 and PolygonsCount<>recordcount And SurveyName='",SurveyName,"'
ORDER BY SurveyName DESC",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF)>0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_CertificationStatus",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: Surveys with records and units but not yet certified

As moose survey data is pulled into the moose monitoring database they are presumed to be raw data unsuitable for analysis. If supporting reports, summaries, or other validating documentation is available and the results match the imported data, then the data for the survey can be certified. Table `r TableCounter` lists surveys that have not yet been certified.

```{r echo=FALSE, label = "Surveys with records and units but not yet certified.",results='asis'}

Sql = paste("SELECT RecordCount,PolygonsCount,PercentCertified,Comments FROM Dashboard 
WHERE (RecordCount > 0 and PolygonsCount > 0 And 
PercentCertified < 1) And SurveyName='",SurveyName,"'
ORDER BY Park,[Year],SurveyName",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF)>0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_CertificationStatus",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_CertificationStatus

Summary of certification status for the `r SurveyName`.

```{r echo=FALSE, label = "Quality control query test results: QC_CertificationStatus",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_CertificationStatus] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_CertificationStatus",sep="")
  print(knitr::kable(t(DF), caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

## QC Test `r QCTestCounter`: QC_GSPE_DoubleSurveyedIDs

This quality control test reveals any units that were surveyed twice. This may arise if data were twice ingested into the database, or some other error occurred where a unit got surveyed twice.

```{r echo=FALSE, label = "Quality control query test results: QC_GSPE_DoubleSurveyedIDs",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_GSPE_DoubleSurveyedIDs] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_GSPE_DoubleSurveyedIDs",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_GSPE_MissingPolygons

Records missing unit polygons.

```{r echo=FALSE, label = "Quality control query test results: QC_GSPE_MissingPolygons",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_GSPE_MissingPolygons] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_GSPE_MissingPolygons",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_PossibleCalfCountErrors_Records

The CALF column should, ideally, be a summation of the number of calves in the COW_W_* columns. The test below shows records where the database calculates a CALF count that differs from the field data.

If the entire CALF column is NULL for the survey (it just hasn't been calculated yet) you may execute the following stored procedure:

`EXEC dbo.UpdateCALF_SAFE '`r SurveyName`'`

This stored procedure will not overwrite any data - it will fail without changing anything if any CALF record for the survey is not NULL. In this case you must find and update the problematic records manually. Here is a query to help isolate problematic records:

`-- Select problem CALF summation records
SELECT SurveyName, ID,COW_W_1,COW_W_2,COW_W_3
,ISNULL(CALF_LONE,0) + ISNULL(COW_W_1,0) + ISNULL(COW_W_2,0) * 2 + ISNULL(COW_W_3,0) * 3 as [CALF (calculated)]
, CALF
,Comments
,Convert(varchar(30),getdate()) + ' ' + SUSER_NAME() + ': CALF was corrected from ' + convert(varchar(4),ISNULL(CALF,0)) + ' to ' + convert(varchar(20),ISNULL(COW_W_1,0) + (ISNULL(COW_W_2,0) * 2) + (ISNULL(COW_W_3,0) * 3)) as UpdateComment
FROM GSPE 
WHERE (SurveyName = '2024 DENA Moose Survey') 
AND ISNULL(CALF,0) <> (ISNULL(CALF_LONE,0) + ISNULL(COW_W_1,0) + (ISNULL(COW_W_2,0) * 2) + (ISNULL(COW_W_3,0) * 3))
ORDER BY ID`

and, if you are confident in your database skills, an INSERT query to help in fixing them:

`-- DO NOT FORGET TO COMMIT OR ROLLBACK THESE INSERT QUERIES or the database will be left stateless!
BEGIN TRANSACTION -- COMMIT ROLLBACK
UPDATE GSPE SET CALF = ISNULL(CALF_LONE,0) + ISNULL(COW_W_1,0) + ISNULL(COW_W_2,0) * 2 + ISNULL(COW_W_3,0) * 3
,Comments =  Convert(varchar(30),getdate()) + ' ' + SUSER_NAME() + ': CALF was corrected from ' + convert(varchar(4),ISNULL(CALF,0)) + ' to ' + convert(varchar(20),ISNULL(COW_W_1,0) + (ISNULL(COW_W_2,0) * 2) + (ISNULL(COW_W_3,0) * 3))
WHERE (SurveyName = '2024 DENA Moose Survey') 
AND ISNULL(CALF,0) <> (ISNULL(CALF_LONE,0) + ISNULL(COW_W_1,0) + (ISNULL(COW_W_2,0) * 2) + (ISNULL(COW_W_3,0) * 3))`

```{r echo=FALSE, label = "Quality control query test results: QC_PossibleCalfCountErrors_Records",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_PossibleCalfCountErrors_Records] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_PossibleCalfCountErrors_Records",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_PossibleBullCountErrors_Records

The BULL_ALL column should, ideally, be a summation of the number of bulls in the BULL_* columns. The test below shows records where the database calculates a BULL_ALL count that differs from the field data.

If the entire BULL_ALL column is NULL for the survey (it just hasn't been calculated yet) you may execute the following stored procedure:

`EXEC dbo.UpdateBULL_ALL_SAFE '`r SurveyName`'`

This stored procedure will not overwrite any data - it will fail without changing anything if any BULL_ALL record for the survey is not NULL. In this case you must find and update the problematic records manually. 

```{r echo=FALSE, label = "Quality control query test results: QC_PossibleBullCountErrors_Records",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_PossibleBullCountErrors_Records] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_PossibleBullCountErrors_Records",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_PossibleCowCountErrors_Records


The COW column should, ideally, be a summation of the number of cows in the COW_W_* columns. The test below shows records where the database calculates a COW count that differs from the field data.

NOTE: This test will return false positives if the survey did not intend to fill the COW_W_* columns, but rather counted cows in aggregate, regardless of calf status (i.e. the COW_W_* columns should be NULL)

If the entire COW column is NULL for the survey (it just hasn't been calculated yet) you may execute the following stored procedure:

`EXEC dbo.UpdateCOW_SAFE '`r SurveyName`'`

This stored procedure will not overwrite any data - it will fail without changing anything if any COW record for the survey is not NULL. In this case you must find and update the problematic records manually. A starting query:

`-- Select problem COW summation records
SELECT SurveyName, ID,COW_W_1,COW_W_2,COW_W_3,COW
,ISNULL(COW_W_0,0),ISNULL(COW_W_1,0) + ISNULL(COW_W_2,0) + ISNULL(COW_W_3,0) As [COW (calculated)]
, COW
,Comments
,Convert(varchar(30),getdate()) + ' ' + SUSER_NAME() + ': COW was corrected from ' + convert(varchar(4),ISNULL(COW,0)) + ' to ' + convert(varchar(20),ISNULL(COW_W_1,0) + (ISNULL(COW_W_2,0) * 2) + (ISNULL(COW_W_3,0) * 3)) as UpdateComment
FROM GSPE 
WHERE (SurveyName = '`r SurveyName`') 
AND ISNULL(COW,0) <>  (ISNULL(COW_W_0,0) + ISNULL(COW_W_1,0) + ISNULL(COW_W_2,0) + ISNULL(COW_W_3,0))
ORDER BY COW_W_0,COW_W_1,COW_W_2,COW_W_3`

```{r echo=FALSE, label = "Quality control query test results: QC_PossibleCowCountErrors_Records",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_PossibleCowCountErrors_Records] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_PossibleCowCountErrors_Records",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_PossibleAdultCountErrors_Records

The ADULT column should, ideally, be a summation of COW and BULL. The test below shows records where the database calculates an ADULT count that differs from the field data.

Records shown below may not be an error if only sub-adults were surveyed. The Adult (calculated) column shows the presumed correct ADULT count and should match the count in ADULT. If the entire ADULT column is NULL for the survey (it just hasn't been calculated yet) you may execute the following stored procedure:

`EXEC dbo.UpdateADULT_SAFE '`r SurveyName`'`

This stored procedure will not overwrite any data; it will fail without changing anything if any ADULT record for the survey is not NULL. In this case you must find and update the problematic records manually. Here is a query to help isolate problematic records:

`SELECT SurveyName, ID,COW + BULL_ALL as [ADULT (calculated)], ADULT, BULL_ALL, COW FROM GSPE WHERE (SurveyName = '`r SurveyName`') AND (ADULT <> (COW + BULL_ALL)) ORDER BY ID`

```{r echo=FALSE, label = "Quality control query test results: QC_PossibleAdultCountErrors_Records",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_PossibleAdultCountErrors_Records] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_PossibleAdultCountErrors_Records",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`


## QC Test `r QCTestCounter`: QC_PossibleMooseCountErrors_Records

Moose should be a correct summation of total calves and adults.

```{r echo=FALSE, label = "Quality control query test results: QC_PossibleMooseCountErrors_Records",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_PossibleMooseCountErrors_Records] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_PossibleMooseCountErrors_Records",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_PossiblyBadXYCoordinates

```{r echo=FALSE, label = "Quality control query test results: QC_PossiblyBadXYCoordinates",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_PossiblyBadXYCoordinates] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_PossiblyBadXYCoordinates",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_SurveysMissingUnits

```{r echo=FALSE, label = "Quality control query test results: QC_SurveysMissingUnits",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_SurveysMissingUnits] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF) > 0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_SurveysMissingUnits",sep="")
  print(knitr::kable(DF, caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

SQL: `r Sql`

## QC Test `r QCTestCounter`: QC_SurveysWithNoDates

This test shows records having no data collection date.

```{r echo=FALSE, label = "Quality control query test results: QC_SurveysWithNoDates",results='asis'}

# Run the quality control query
Sql = paste("SELECT * FROM [QC_SurveysWithNoDates] WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)

# Print a Pass/Fail message with failing records summary
if(nrow(DF)>0){
  cat("\n**FAILED**\n\n")
  # Output the results
  Caption = paste("Table ",TableCounter,". Quality control query test results: QC_SurveysWithNoDates",sep="")
  print(knitr::kable(t(DF), caption = Caption))
} else {
  cat("\nPASSED\n")
}
# I don't know why this bombs the if block above, but I had to put it here
if(nrow(DF) > 0){ TableCounter = TableCounter + 1 } 
if(nrow(DF) > 0){ QCTestCounter = QCTestCounter + 1 } 
```

## Dataset Processing Steps

Below are notes recorded during the data management life cycle from field data -\> database ingestion, through quality control and assessment, and dataset certification.

```{r echo=FALSE, label = "Dataset Processing Steps"}

# Run the quality control query
Sql = paste("SELECT DatasetProcessingSteps FROM GSPE_Surveys WHERE SurveyName='",SurveyName,"'",sep="")
DF = dbGetQuery(Connection,Sql)
knitr::kable(DF)
TableCounter = TableCounter + 1 

```

SQL: `r Sql`

```{r,label="Write the report to the survey directory", echo=FALSE}

# This template will output to an html file named MooseSurveyReport.htms
# Rename it and copy it to the survey directory if it exists
# Otherwise rename it in the current directory
From = "Moose-Survey-Quality-Control-Report.html"

# Set up the source file title
ReportTitle = paste(SurveyName," Quality Control Report.html",sep="")


# Check if the survey directory exists
# Set up a destination file path for the file copy operation
if (dir.exists(DashboardDF$DataResourcesDirectory)) {
  To=paste(DashboardDF$DataResourcesDirectory,"/",ReportTitle,sep="")
} else {
  To=ReportTitle
}

# Try to copy the file to the destination
tryCatch({
  file.copy(From, To, overwrite = TRUE)
  message(paste("Survey report ",From," generated and and copied to ",To,sep=""))
}, error = function(e) {
  
  # An error happened
  message("Error: ", e$message)
  
})


```
